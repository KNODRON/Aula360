/* index.html */
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EscÃ¡ner de Documentos</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>EscÃ¡ner de Documentos</h1>
  <video id="video" autoplay playsinline></video>
  <button onclick="capturar()">ðŸ“¸ Capturar</button>
  <button onclick="guardarImagen()">ðŸ’¾ Guardar Imagen</button>
  <button onclick="aplicarFiltro('bw')">ðŸŒ“ B/N</button>
  <button onclick="aplicarFiltro('enhance')">âœ¨ Mejorar</button>
  <canvas id="canvas"></canvas>

  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="cv['onRuntimeInitialized']=inicializarOpenCV;"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="app.js"></script>
</body>
</html>

/* style.css */
body {
  text-align: center;
  font-family: sans-serif;
  background-color: #f5f5f5;
  margin: 0;
  padding: 0;
}

video, canvas {
  width: 90%;
  max-width: 400px;
  margin: 10px auto;
  display: block;
  border: 2px solid #ccc;
  border-radius: 10px;
}

button {
  padding: 10px 20px;
  font-size: 16px;
  margin: 5px;
  cursor: pointer;
}

/* manifest.json */
{
  "short_name": "DocScan",
  "name": "EscÃ¡ner de Documentos MÃ³vil",
  "start_url": "./index.html",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0ea5e9",
  "icons": [
    { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}

/* service-worker.js */
self.addEventListener('install', e => self.skipWaiting());
self.addEventListener('activate', e => self.clients.claim());
self.addEventListener('fetch', e => {
  e.respondWith(
    caches.match(e.request).then(r => r || fetch(e.request))
  );
});

/* app.js */
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let streaming = false;

function inicializarOpenCV() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
      video.play();
    });

  video.addEventListener("canplay", () => {
    if (!streaming) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      streaming = true;
    }
  });
}

function capturar() {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  let src = cv.imread(canvas);
  let dst = new cv.Mat();
  let gray = new cv.Mat();
  let blurred = new cv.Mat();
  let edges = new cv.Mat();

  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
  cv.Canny(blurred, edges, 75, 200);

  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(edges, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);

  let biggest = null;
  let maxArea = 0;
  for (let i = 0; i < contours.size(); i++) {
    let cnt = contours.get(i);
    let peri = cv.arcLength(cnt, true);
    let approx = new cv.Mat();
    cv.approxPolyDP(cnt, approx, 0.02 * peri, true);

    if (approx.rows === 4) {
      let area = cv.contourArea(cnt);
      if (area > maxArea) {
        maxArea = area;
        biggest = approx;
      }
    }
  }

  if (biggest) {
    let pts1 = cv.matFromArray(4, 1, cv.CV_32FC2, [
      biggest.data32F[0], biggest.data32F[1],
      biggest.data32F[2], biggest.data32F[3],
      biggest.data32F[4], biggest.data32F[5],
      biggest.data32F[6], biggest.data32F[7],
    ]);

    let width = canvas.width;
    let height = canvas.height;
    let pts2 = cv.matFromArray(4, 1, cv.CV_32FC2, [
      0, 0,
      width, 0,
      width, height,
      0, height
    ]);

    let M = cv.getPerspectiveTransform(pts1, pts2);
    cv.warpPerspective(src, dst, M, new cv.Size(width, height));
    cv.imshow(canvas, dst);

    pts1.delete(); pts2.delete(); M.delete();
  }

  src.delete(); dst.delete(); gray.delete(); blurred.delete();
  edges.delete(); contours.delete(); hierarchy.delete();
}

function guardarImagen() {
  let enlace = document.createElement('a');
  enlace.download = "escaneo.png";
  enlace.href = canvas.toDataURL();
  enlace.click();
}

function aplicarFiltro(tipo) {
  let src = cv.imread(canvas);
  let dst = new cv.Mat();
  if (tipo === 'bw') {
    cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
    cv.cvtColor(dst, dst, cv.COLOR_GRAY2RGBA);
  } else if (tipo === 'enhance') {
    cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
    cv.equalizeHist(dst, dst);
    cv.cvtColor(dst, dst, cv.COLOR_GRAY2RGBA);
  }
  cv.imshow(canvas, dst);
  src.delete(); dst.delete();
}

window.guardarPDF = async function() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const imgData = canvas.toDataURL("image/png");
  pdf.addImage(imgData, 'PNG', 10, 10, 180, 160);
  pdf.save("escaneo.pdf");
};
